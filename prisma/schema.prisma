// Prisma schema for AML Core KYC domain
// Learn more about it in the docs: https://pris.ly/d/prisma-schema
// NOTE: All column names use snake_case via @map directives for consistency

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum PersonType {
  PHYSICAL
  MORAL
  TRUST
}

enum DocumentType {
  // ID Documents
  PASSPORT
  NATIONAL_ID // INE
  DRIVERS_LICENSE
  CEDULA_PROFESIONAL
  CARTILLA_MILITAR
  // Tax Documents
  TAX_ID // RFC / Constancia de Situaci√≥n Fiscal
  // Address Proof
  PROOF_OF_ADDRESS
  UTILITY_BILL
  BANK_STATEMENT
  // Corporate Documents
  ACTA_CONSTITUTIVA
  PODER_NOTARIAL
  TRUST_AGREEMENT
  CORPORATE_BYLAWS
  // Other
  OTHER
}

// KYC completion status
enum KYCStatus {
  INCOMPLETE // Missing required documents or information
  PENDING_VERIFICATION // Documents uploaded, awaiting verification
  COMPLETE // All requirements met
  EXPIRED // Documents have expired, needs renewal
}

// PEP check status
enum PEPStatus {
  PENDING // Not yet checked
  CONFIRMED // Confirmed as PEP
  NOT_PEP // Confirmed not a PEP
  ERROR // Check failed, needs retry
}

// UBO relationship types
enum UBORelationshipType {
  SHAREHOLDER // Direct shareholder with 25%+ ownership
  DIRECTOR // Board member or director
  LEGAL_REP // Legal representative
  TRUSTEE // Trustee (for trusts)
  SETTLOR // Settlor/Grantor (for trusts)
  BENEFICIARY // Beneficiary (for trusts)
  CONTROLLER // Person with effective control
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum AddressType {
  RESIDENTIAL
  BUSINESS
  MAILING
  OTHER
}

enum TransactionOperationType {
  PURCHASE
  SALE
}

enum TransactionVehicleType {
  LAND
  MARINE
  AIR
}

model Client {
  id                   String     @id
  rfc                  String // RFC is unique per organization, not globally
  organizationId       String     @map("organization_id") // Organization this client belongs to (from auth-svc)
  personType           PersonType @map("person_type")
  firstName            String?    @map("first_name")
  lastName             String?    @map("last_name")
  secondLastName       String?    @map("second_last_name")
  birthDate            DateTime?  @map("birth_date")
  curp                 String? // CURP is unique per organization, not globally
  businessName         String?    @map("business_name")
  incorporationDate    DateTime?  @map("incorporation_date")
  nationality          String?
  email                String
  phone                String
  country              String
  stateCode            String     @map("state_code")
  city                 String
  municipality         String
  neighborhood         String
  street               String
  externalNumber       String     @map("external_number")
  internalNumber       String?    @map("internal_number")
  postalCode           String     @map("postal_code")
  reference            String?
  notes                String?
  // Catalog references for XML generation
  countryCode          String?    @map("country_code") // Reference to countries catalog (metadata.code)
  economicActivityCode String?    @map("economic_activity_code") // Reference to economic activity catalog (7-digit code)
  // Enhanced KYC fields
  gender               String? // M, F, OTHER
  occupation           String? // Occupation or business activity description
  maritalStatus        String?    @map("marital_status") // SINGLE, MARRIED, DIVORCED, WIDOWED, OTHER
  sourceOfFunds        String?    @map("source_of_funds") // Description of source of funds
  sourceOfWealth       String?    @map("source_of_wealth") // Description of source of wealth
  // KYC status tracking
  kycStatus            KYCStatus  @default(INCOMPLETE) @map("kyc_status")
  kycCompletedAt       DateTime?  @map("kyc_completed_at")
  // PEP status tracking
  isPEP                Boolean    @default(false) @map("is_pep")
  pepStatus            PEPStatus  @default(PENDING) @map("pep_status")
  pepDetails           String?    @map("pep_details") // Details from watchlist-svc
  pepMatchConfidence   String?    @map("pep_match_confidence") // exact, possible
  pepCheckedAt         DateTime?  @map("pep_checked_at") // Last PEP check timestamp
  pepCheckSource       String?    @map("pep_check_source") // VECTORIZE, GROK
  // Timestamps
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")
  deletedAt            DateTime?  @map("deleted_at")

  documents    ClientDocument[]
  addresses    ClientAddress[]
  transactions Transaction[]
  alerts       Alert[]
  reports      Report[] // Reports targeting this specific client
  ubos         UltimateBeneficialOwner[] // UBOs for moral/trust entities

  @@map("clients")
  @@unique([organizationId, rfc]) // RFC must be unique within each organization
  @@index([organizationId])
  @@index([rfc]) // Keep index for lookups
  @@index([personType])
  @@index([deletedAt])
  @@index([countryCode])
  @@index([economicActivityCode])
  @@index([kycStatus])
  @@index([pepStatus])
  @@index([pepCheckedAt])
}

model ClientDocument {
  id             String         @id
  clientId       String         @map("client_id")
  documentType   DocumentType   @map("document_type")
  documentNumber String         @map("document_number")
  issuingCountry String?        @map("issuing_country")
  issueDate      DateTime?      @map("issue_date")
  expiryDate     DateTime?      @map("expiry_date")
  status         DocumentStatus @default(PENDING)
  fileUrl        String?        @map("file_url")
  metadata       String?
  // doc-svc integration fields
  docSvcDocumentId   String?    @map("doc_svc_document_id") // Reference to doc-svc document
  docSvcJobId        String?    @map("doc_svc_job_id") // Processing job ID
  verificationStatus String?    @map("verification_status") // APPROVED, REVIEW, REJECTED
  verificationScore  Float?     @map("verification_score")
  extractedData      String?    @map("extracted_data") // JSON from doc-svc extraction
  verifiedAt         DateTime?  @map("verified_at")
  // Timestamps
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  // Relations for UBO documents
  uboIdDocuments      UltimateBeneficialOwner[] @relation("UBOIdDocument")
  uboAddressProofs    UltimateBeneficialOwner[] @relation("UBOAddressProof")

  @@map("client_documents")
  @@index([clientId])
  @@index([documentType])
  @@index([status])
  @@index([expiryDate])
  @@index([docSvcDocumentId])
  @@index([verificationStatus])
}

model ClientAddress {
  id          String      @id
  clientId    String      @map("client_id")
  addressType AddressType @default(RESIDENTIAL) @map("address_type")
  street1     String
  street2     String?
  city        String
  state       String?
  postalCode  String?     @map("postal_code")
  country     String
  isPrimary   Boolean     @default(false) @map("is_primary")
  verifiedAt  DateTime?   @map("verified_at")
  reference   String?
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_addresses")
  @@index([clientId])
  @@index([addressType])
  @@index([country])
}

// Ultimate Beneficial Owner - for MORAL and TRUST entities
// Required by LFPIORPI for entities where a single person owns 25%+ shares
model UltimateBeneficialOwner {
  id                  String              @id
  clientId            String              @map("client_id")
  // Personal information
  firstName           String              @map("first_name")
  lastName            String              @map("last_name")
  secondLastName      String?             @map("second_last_name")
  birthDate           DateTime?           @map("birth_date")
  nationality         String?
  curp                String? // Mexican CURP if applicable
  rfc                 String? // Mexican RFC if applicable
  // Ownership/relationship details
  ownershipPercentage Decimal?            @map("ownership_percentage") // Percentage of ownership (for shareholders)
  relationshipType    UBORelationshipType @map("relationship_type")
  position            String? // Job title or position description
  // Contact information
  email               String?
  phone               String?
  // Address
  country             String?
  stateCode           String?             @map("state_code")
  city                String?
  street              String?
  postalCode          String?             @map("postal_code")
  // Document references
  idDocumentId        String?             @map("id_document_id") // FK to ClientDocument
  addressProofId      String?             @map("address_proof_id") // FK to ClientDocument
  // PEP status tracking (UBOs also need PEP checking)
  isPEP               Boolean             @default(false) @map("is_pep")
  pepStatus           PEPStatus           @default(PENDING) @map("pep_status")
  pepDetails          String?             @map("pep_details")
  pepMatchConfidence  String?             @map("pep_match_confidence")
  pepCheckedAt        DateTime?           @map("pep_checked_at")
  // Verification
  verifiedAt          DateTime?           @map("verified_at")
  verifiedBy          String?             @map("verified_by")
  notes               String?
  // Timestamps
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  client       Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  idDocument   ClientDocument? @relation("UBOIdDocument", fields: [idDocumentId], references: [id], onDelete: SetNull)
  addressProof ClientDocument? @relation("UBOAddressProof", fields: [addressProofId], references: [id], onDelete: SetNull)

  @@map("ultimate_beneficial_owners")
  @@index([clientId])
  @@index([relationshipType])
  @@index([pepStatus])
  @@index([pepCheckedAt])
}

model Catalog {
  id            String        @id
  key           String        @unique
  name          String
  active        Boolean       @default(true)
  allowNewItems Boolean       @default(false) @map("allow_new_items") // When true, users can add new items to this catalog
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  items CatalogItem[]

  @@map("catalogs")
  @@index([active])
}

model CatalogItem {
  id             String   @id
  catalogId      String   @map("catalog_id")
  name           String
  normalizedName String   @map("normalized_name")
  active         Boolean  @default(true)
  metadata       String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  catalog Catalog @relation(fields: [catalogId], references: [id], onDelete: Cascade)

  @@map("catalog_items")
  @@index([catalogId])
  @@index([normalizedName])
  @@index([active])
}

model Transaction {
  id                 String                   @id
  organizationId     String                   @map("organization_id") // Organization this transaction belongs to (from auth-svc)
  clientId           String                   @map("client_id")
  operationDate      DateTime                 @map("operation_date")
  operationType      TransactionOperationType @map("operation_type")
  branchPostalCode   String                   @map("branch_postal_code")
  vehicleType        TransactionVehicleType   @map("vehicle_type")
  brandId            String                   @map("brand_id")
  model              String
  year               Int
  armorLevel         String?                  @map("armor_level")
  engineNumber       String?                  @map("engine_number")
  plates             String?
  registrationNumber String?                  @map("registration_number")
  flagCountryId      String?                  @map("flag_country_id")
  amount             Decimal
  currency           String
  // Catalog references for XML generation
  operationTypeCode  String?                  @map("operation_type_code") // Reference to veh-operation-types catalog (metadata.code, e.g., "802")
  currencyCode       String?                  @map("currency_code") // Reference to currencies catalog (metadata.code, e.g., "3" for MXN)
  // UMA value calculation (automatically calculated and saved)
  umaValue           Decimal?                 @map("uma_value") // Calculated: amount / umaDailyValue for the transaction date
  createdAt          DateTime                 @default(now()) @map("created_at")
  updatedAt          DateTime                 @updatedAt @map("updated_at")
  deletedAt          DateTime?                @map("deleted_at")

  client         Client                     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  paymentMethods TransactionPaymentMethod[]

  @@map("transactions")
  @@index([organizationId])
  @@index([clientId])
  @@index([operationDate])
  @@index([operationType])
  @@index([vehicleType])
  @@index([operationTypeCode])
  @@index([currencyCode])
}

model TransactionPaymentMethod {
  id            String   @id
  transactionId String   @map("transaction_id")
  method        String
  amount        Decimal
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_payment_methods")
  @@index([transactionId])
}

enum AlertStatus {
  DETECTED // Alert detected, awaiting file generation
  FILE_GENERATED // File generated for SAT submission, ready to submit
  SUBMITTED // Successfully submitted to SAT with acknowledgment
  OVERDUE // Submission deadline has passed (worst case - penalties)
  CANCELLED // Alert was cancelled/dismissed (e.g., false positive)
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Notice status for SAT regulatory submissions
enum NoticeStatus {
  DRAFT // Created, not yet generated
  GENERATED // XML file generated
  SUBMITTED // Sent to SAT
  ACKNOWLEDGED // SAT acknowledged receipt
}

// Report types for analytics/business intelligence (all use calendar periods)
enum ReportPeriodType {
  MONTHLY // Calendar month (1st-last day)
  QUARTERLY // Calendar quarter
  ANNUAL // Calendar year
  CUSTOM // Custom date range
}

// Report templates for common use cases
enum ReportTemplate {
  EXECUTIVE_SUMMARY // High-level compliance overview
  COMPLIANCE_STATUS // Audit-ready compliance report
  TRANSACTION_ANALYSIS // Transaction volume & patterns
  CLIENT_RISK_PROFILE // Deep-dive on specific client
  ALERT_BREAKDOWN // Alert management metrics
  PERIOD_COMPARISON // Trend analysis
  CUSTOM // User-defined report
}

// Report status (simplified - no SAT workflow)
enum ReportStatus {
  DRAFT // Created, not yet generated
  GENERATED // PDF generated
}

model AlertRule {
  id           String        @id // Alert code (e.g., "2501", "2502", "9999")
  name         String
  description  String?
  active       Boolean       @default(true)
  severity     AlertSeverity @default(MEDIUM)
  ruleType     String?       @map("rule_type") // Matches seeker's ruleType (null for manual-only rules)
  isManualOnly Boolean       @default(false) @map("is_manual_only") // True if only manual triggers
  activityCode String        @default("VEH") @map("activity_code") // VEH, JYS, INM, JOY, ART
  metadata     String? // Additional metadata as JSON (legal basis, category, etc.)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  alerts  Alert[]
  configs AlertRuleConfig[]

  @@map("alert_rules")
  @@index([active])
  @@index([severity])
  @@index([ruleType])
  @@index([activityCode])
  @@index([isManualOnly])
}

model AlertRuleConfig {
  id          String   @id
  alertRuleId String   @map("alert_rule_id")
  key         String // Config key (e.g., "uma_threshold", "max_cash_amount")
  value       String // JSON string value
  isHardcoded Boolean  @default(false) @map("is_hardcoded") // True if should not be updated via API
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  alertRule AlertRule @relation(fields: [alertRuleId], references: [id], onDelete: Cascade)

  @@unique([alertRuleId, key])
  @@map("alert_rule_config")
  @@index([alertRuleId])
  @@index([key])
  @@index([isHardcoded])
}

model Alert {
  id                       String        @id
  organizationId           String        @map("organization_id") // Organization this alert belongs to (from auth-svc)
  alertRuleId              String        @map("alert_rule_id")
  clientId                 String        @map("client_id")
  reportId                 String?       @map("report_id") // Optional reference to analytics report (PDF)
  noticeId                 String?       @map("notice_id") // Optional reference to SAT notice (XML)
  status                   AlertStatus   @default(DETECTED)
  severity                 AlertSeverity
  // Idempotency key: hash of (clientId + alertRuleId + contextHash)
  // This ensures we never create duplicate alerts for the same condition
  idempotencyKey           String        @unique @map("idempotency_key")
  // Context hash: hash of the specific data that triggered this alert
  // Example: hash of transaction IDs, amounts, dates, etc.
  contextHash              String        @map("context_hash")
  // Alert details stored as JSON (transaction IDs, amounts, dates, etc.)
  metadata                 String // JSON string with alert-specific data (renamed from alertData)
  // Optional reference to the transaction that triggered the alert
  transactionId            String?       @map("transaction_id") // Renamed from triggerTransactionId
  isManual                 Boolean       @default(false) @map("is_manual") // True if manually created
  // SAT Submission tracking (managed via Notice)
  submissionDeadline       DateTime?     @map("submission_deadline") // Deadline for SAT submission (day 17 of following month for avisos, 24h for suspicion)
  fileGeneratedAt          DateTime?     @map("file_generated_at") // When the SAT file was generated (via notice)
  submittedAt              DateTime?     @map("submitted_at") // When submitted to SAT
  satAcknowledgmentReceipt String?       @map("sat_acknowledgment_receipt") // File URL or reference to SAT acknowledgment (PDF/XML)
  satFolioNumber           String?       @map("sat_folio_number") // Folio number from SAT acknowledgment
  isOverdue                Boolean       @default(false) @map("is_overdue") // Computed: true if submissionDeadline has passed and status != SUBMITTED
  // Review and cancellation
  notes                    String?
  reviewedAt               DateTime?     @map("reviewed_at")
  reviewedBy               String?       @map("reviewed_by")
  cancelledAt              DateTime?     @map("cancelled_at")
  cancelledBy              String?       @map("cancelled_by")
  cancellationReason       String?       @map("cancellation_reason") // Reason for cancellation
  createdAt                DateTime      @default(now()) @map("created_at")
  updatedAt                DateTime      @updatedAt @map("updated_at")

  alertRule AlertRule @relation(fields: [alertRuleId], references: [id], onDelete: Restrict)
  client    Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  report    Report?   @relation(fields: [reportId], references: [id], onDelete: SetNull)
  notice    Notice?   @relation(fields: [noticeId], references: [id], onDelete: SetNull)

  @@map("alerts")
  @@index([organizationId])
  @@index([alertRuleId])
  @@index([clientId])
  @@index([reportId])
  @@index([noticeId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
  @@index([idempotencyKey])
  @@index([submissionDeadline])
  @@index([isOverdue])
  @@index([submittedAt])
  @@index([transactionId])
  @@index([isManual])
}

model UmaValue {
  id            String    @id
  year          Int       @unique // Year this UMA value applies to (e.g., 2025)
  dailyValue    Decimal   @map("daily_value") // UMA daily value for the year
  effectiveDate DateTime  @map("effective_date") // Date when this UMA value becomes effective
  endDate       DateTime? @map("end_date") // Optional: date when this UMA value expires (usually end of year)
  approvedBy    String?   @map("approved_by") // User who approved/configured this value (Compliance Officer)
  notes         String? // Optional notes about the UMA value
  active        Boolean   @default(true) // Whether this is the current active UMA value
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("uma_values")
  @@index([year])
  @@index([active])
  @@index([effectiveDate])
}

// Organization Settings - stores RFC and vulnerable activity for the organization
// Linked 1:1 to organization (from auth-svc better-auth organization plugin)
model OrganizationSettings {
  id                  String   @id
  organizationId      String   @unique @map("organization_id") // Organization ID from auth-svc
  obligatedSubjectKey String   @map("obligated_subject_key") // RFC (clave_sujeto_obligado) - 12 characters
  activityKey         String   @map("activity_key") // Vulnerable activity code (e.g., "VEH") - reference to vulnerable-activities catalog
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@map("organization_settings")
  @@index([organizationId])
  @@index([obligatedSubjectKey])
  @@index([activityKey])
}

// Notice - SAT regulatory submissions (avisos) with 17-17 period handling
model Notice {
  id             String       @id
  organizationId String       @map("organization_id") // Organization this notice belongs to
  name           String // Display name (e.g., "Aviso Diciembre 2024")
  status         NoticeStatus @default(DRAFT)
  periodStart    DateTime     @map("period_start") // Day 17 of previous month
  periodEnd      DateTime     @map("period_end") // Day 16 of current month
  reportedMonth  String       @map("reported_month") // YYYYMM format for SAT
  recordCount    Int          @default(0) @map("record_count") // Number of alerts included
  // XML file output
  xmlFileUrl     String?      @map("xml_file_url") // R2 URL of SAT XML
  fileSize       Int?         @map("file_size") // XML file size in bytes
  generatedAt    DateTime?    @map("generated_at") // When the XML was generated
  submittedAt    DateTime?    @map("submitted_at") // When submitted to SAT
  satFolioNumber String?      @map("sat_folio_number") // SAT acknowledgment folio number
  createdBy      String?      @map("created_by") // User ID who created the notice
  notes          String? // Optional notes
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  alerts Alert[] // Alerts included in this notice

  @@map("notices")
  @@index([organizationId])
  @@index([status])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([reportedMonth])
}

// Report - Analytics and business intelligence reports (PDF)
model Report {
  id                    String           @id
  organizationId        String           @map("organization_id") // Organization this report belongs to
  name                  String // Display name (e.g., "Monthly Report December 2024")
  // Report configuration
  template              ReportTemplate   @default(CUSTOM)
  periodType            ReportPeriodType @default(CUSTOM) @map("period_type")
  periodStart           DateTime         @map("period_start") // Start of reporting period
  periodEnd             DateTime         @map("period_end") // End of reporting period
  // Optional comparison period for trend analysis
  comparisonPeriodStart DateTime?        @map("comparison_period_start")
  comparisonPeriodEnd   DateTime?        @map("comparison_period_end")
  // Data sources and filtering (stored as JSON)
  dataSources           String           @default("[\"ALERTS\"]") @map("data_sources") // JSON array: ["ALERTS", "TRANSACTIONS", "CLIENTS"]
  filters               String           @default("{}") // JSON object with filter configuration
  clientId              String?          @map("client_id") // For CLIENT_RISK_PROFILE template
  // Visualization settings (stored as JSON)
  charts                String           @default("[]") // JSON array of chart configurations
  includeSummaryCards   Boolean          @default(true) @map("include_summary_cards")
  includeDetailTables   Boolean          @default(true) @map("include_detail_tables")
  // Report state
  status                ReportStatus     @default(DRAFT)
  // PDF output
  pdfFileUrl            String?          @map("pdf_file_url") // R2 URL of PDF report
  fileSize              Int?             @map("file_size") // PDF file size in bytes
  generatedAt           DateTime?        @map("generated_at") // When the PDF was generated
  createdBy             String?          @map("created_by") // User ID who created the report
  notes                 String? // Optional notes
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  alerts Alert[] // Alerts included in this report (for filtering/aggregation)
  client Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@map("reports")
  @@index([organizationId])
  @@index([template])
  @@index([periodType])
  @@index([status])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([clientId])
}

// Import status for bulk data imports
enum ImportStatus {
  PENDING // Uploaded, awaiting processing
  VALIDATING // Worker is parsing and validating file
  PROCESSING // Processing rows
  COMPLETED // All rows processed
  FAILED // Catastrophic error
}

// Entity types that can be imported
enum ImportEntityType {
  CLIENT
  TRANSACTION
}

// Status of individual import rows
enum ImportRowStatus {
  PENDING
  SUCCESS
  WARNING
  ERROR
  SKIPPED
}

// Import - Bulk data import job tracking
model Import {
  id             String           @id
  organizationId String           @map("organization_id")
  entityType     ImportEntityType @map("entity_type")
  fileName       String           @map("file_name")
  fileUrl        String           @map("file_url") // R2 key
  fileSize       Int              @map("file_size")
  status         ImportStatus     @default(PENDING)
  totalRows      Int              @default(0) @map("total_rows")
  processedRows  Int              @default(0) @map("processed_rows")
  successCount   Int              @default(0) @map("success_count")
  warningCount   Int              @default(0) @map("warning_count")
  errorCount     Int              @default(0) @map("error_count")
  errorMessage   String?          @map("error_message") // Catastrophic error message
  createdBy      String           @map("created_by") // User ID who initiated the import
  startedAt      DateTime?        @map("started_at") // When processing started
  completedAt    DateTime?        @map("completed_at") // When processing completed
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  rowResults ImportRowResult[]

  @@map("imports")
  @@index([organizationId])
  @@index([status])
  @@index([entityType])
  @@index([createdAt])
  @@index([createdBy])
}

// ImportRowResult - Individual row processing results
model ImportRowResult {
  id        String          @id
  importId  String          @map("import_id")
  rowNumber Int             @map("row_number")
  status    ImportRowStatus @default(PENDING)
  rawData   String          @map("raw_data") // JSON of original row data
  entityId  String?         @map("entity_id") // Created client/transaction ID if successful
  message   String? // Human-readable status message
  errors    String? // JSON array of validation errors
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  import Import @relation(fields: [importId], references: [id], onDelete: Cascade)

  @@map("import_row_results")
  @@index([importId])
  @@index([status])
  @@index([rowNumber])
}
