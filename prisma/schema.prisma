// Prisma schema for AML Core KYC domain
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum PersonType {
  PHYSICAL
  MORAL
  TRUST
}

enum DocumentType {
  PASSPORT
  NATIONAL_ID
  DRIVERS_LICENSE
  TAX_ID
  PROOF_OF_ADDRESS
  OTHER
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum AddressType {
  RESIDENTIAL
  BUSINESS
  MAILING
  OTHER
}

enum TransactionOperationType {
  PURCHASE
  SALE
}

enum TransactionVehicleType {
  LAND
  MARINE
  AIR
}

model Client {
  id                String     @id
  rfc               String     @unique
  organizationId    String     // Organization this client belongs to (from auth-svc)
  personType        PersonType
  firstName         String?
  lastName          String?
  secondLastName    String?
  birthDate         DateTime?
  curp              String?
  businessName      String?
  incorporationDate DateTime?
  nationality       String?
  email             String
  phone             String
  country           String
  stateCode         String
  city              String
  municipality      String
  neighborhood      String
  street            String
  externalNumber    String
  internalNumber    String?
  postalCode        String
  reference         String?
  notes             String?
  // Catalog references for XML generation
  countryCode       String?    // Reference to countries catalog (metadata.code)
  economicActivityCode String? // Reference to economic activity catalog (7-digit code)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  deletedAt         DateTime?

  documents ClientDocument[]
  addresses ClientAddress[]
  transactions Transaction[]
  alerts Alert[]
  reports Report[]  // Reports targeting this specific client

  @@map("clients")
  @@index([organizationId])
  @@index([personType])
  @@index([deletedAt])
  @@index([countryCode])
  @@index([economicActivityCode])
}

model ClientDocument {
  id             String         @id
  clientId       String
  documentType   DocumentType
  documentNumber String
  issuingCountry String?
  issueDate      DateTime?
  expiryDate     DateTime?
  status         DocumentStatus @default(PENDING)
  fileUrl        String?
  metadata       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_documents")
  @@index([clientId])
  @@index([documentType])
  @@index([status])
  @@index([expiryDate])
}

model ClientAddress {
  id          String      @id
  clientId    String
  addressType AddressType @default(RESIDENTIAL)
  street1     String
  street2     String?
  city        String
  state       String?
  postalCode  String?
  country     String
  isPrimary   Boolean     @default(false)
  verifiedAt  DateTime?
  reference   String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_addresses")
  @@index([clientId])
  @@index([addressType])
  @@index([country])
}

model Catalog {
  id            String        @id
  key           String        @unique
  name          String
  active        Boolean       @default(true)
  allowNewItems Boolean       @default(false) // When true, users can add new items to this catalog
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  items CatalogItem[]

  @@map("catalogs")
  @@index([active])
}

model CatalogItem {
  id             String   @id
  catalogId      String
  name           String
  normalizedName String
  active         Boolean  @default(true)
  metadata       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  catalog Catalog @relation(fields: [catalogId], references: [id], onDelete: Cascade)

  @@map("catalog_items")
  @@index([catalogId])
  @@index([normalizedName])
  @@index([active])
}

model Transaction {
  id                String                     @id
  organizationId    String                     // Organization this transaction belongs to (from auth-svc)
  clientId          String
  operationDate     DateTime
  operationType     TransactionOperationType
  branchPostalCode  String
  vehicleType       TransactionVehicleType
  brandId           String
  model             String
  year              Int
  armorLevel        String?
  engineNumber      String?
  plates            String?
  registrationNumber String?
  flagCountryId     String?
  amount            Decimal
  currency          String
  // Catalog references for XML generation
  operationTypeCode String?    // Reference to veh-operation-types catalog (metadata.code, e.g., "802")
  currencyCode      String?    // Reference to currencies catalog (metadata.code, e.g., "3" for MXN)
  // UMA value calculation (automatically calculated and saved)
  umaValue          Decimal?   // Calculated: amount / umaDailyValue for the transaction date
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  deletedAt         DateTime?

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  paymentMethods    TransactionPaymentMethod[]

  @@map("transactions")
  @@index([organizationId])
  @@index([clientId])
  @@index([operationDate])
  @@index([operationType])
  @@index([vehicleType])
  @@index([operationTypeCode])
  @@index([currencyCode])
}

model TransactionPaymentMethod {
  id            String      @id
  transactionId String
  method        String
  amount        Decimal
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_payment_methods")
  @@index([transactionId])
}

enum AlertStatus {
  DETECTED        // Alert detected, awaiting file generation
  FILE_GENERATED  // File generated for SAT submission, ready to submit
  SUBMITTED       // Successfully submitted to SAT with acknowledgment
  OVERDUE         // Submission deadline has passed (worst case - penalties)
  CANCELLED       // Alert was cancelled/dismissed (e.g., false positive)
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Notice status for SAT regulatory submissions
enum NoticeStatus {
  DRAFT        // Created, not yet generated
  GENERATED    // XML file generated
  SUBMITTED    // Sent to SAT
  ACKNOWLEDGED // SAT acknowledged receipt
}

// Report types for analytics/business intelligence (all use calendar periods)
enum ReportPeriodType {
  MONTHLY     // Calendar month (1st-last day)
  QUARTERLY   // Calendar quarter
  ANNUAL      // Calendar year
  CUSTOM      // Custom date range
}

// Report templates for common use cases
enum ReportTemplate {
  EXECUTIVE_SUMMARY      // High-level compliance overview
  COMPLIANCE_STATUS      // Audit-ready compliance report
  TRANSACTION_ANALYSIS   // Transaction volume & patterns
  CLIENT_RISK_PROFILE    // Deep-dive on specific client
  ALERT_BREAKDOWN        // Alert management metrics
  PERIOD_COMPARISON      // Trend analysis
  CUSTOM                 // User-defined report
}

// Report status (simplified - no SAT workflow)
enum ReportStatus {
  DRAFT        // Created, not yet generated
  GENERATED    // PDF generated
}

model AlertRule {
  id             String   @id // Alert code (e.g., "2501", "2502", "9999")
  name           String
  description    String?
  active         Boolean  @default(true)
  severity       AlertSeverity @default(MEDIUM)
  ruleType       String?  // Matches seeker's ruleType (null for manual-only rules)
  isManualOnly   Boolean  @default(false) // True if only manual triggers
  activityCode   String   @default("VEH") // VEH, JYS, INM, JOY, ART
  metadata       String?  // Additional metadata as JSON (legal basis, category, etc.)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  alerts  Alert[]
  configs AlertRuleConfig[]

  @@map("alert_rules")
  @@index([active])
  @@index([severity])
  @@index([ruleType])
  @@index([activityCode])
  @@index([isManualOnly])
}

model AlertRuleConfig {
  id           String   @id
  alertRuleId  String
  key          String   // Config key (e.g., "uma_threshold", "max_cash_amount")
  value        String   // JSON string value
  isHardcoded  Boolean  @default(false) // True if should not be updated via API
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  alertRule AlertRule @relation(fields: [alertRuleId], references: [id], onDelete: Cascade)

  @@unique([alertRuleId, key])
  @@map("alert_rule_config")
  @@index([alertRuleId])
  @@index([key])
  @@index([isHardcoded])
}

model Alert {
  id                String      @id
  organizationId    String      // Organization this alert belongs to (from auth-svc)
  alertRuleId       String
  clientId          String
  reportId          String?     // Optional reference to analytics report (PDF)
  noticeId          String?     // Optional reference to SAT notice (XML)
  status            AlertStatus @default(DETECTED)
  severity          AlertSeverity
  // Idempotency key: hash of (clientId + alertRuleId + contextHash)
  // This ensures we never create duplicate alerts for the same condition
  idempotencyKey    String      @unique
  // Context hash: hash of the specific data that triggered this alert
  // Example: hash of transaction IDs, amounts, dates, etc.
  contextHash       String
  // Alert details stored as JSON (transaction IDs, amounts, dates, etc.)
  metadata          String      // JSON string with alert-specific data (renamed from alertData)
  // Optional reference to the transaction that triggered the alert
  transactionId     String?     // Renamed from triggerTransactionId
  isManual          Boolean     @default(false) // True if manually created
  
  // SAT Submission tracking (managed via Notice)
  submissionDeadline DateTime?  // Deadline for SAT submission (day 17 of following month for avisos, 24h for suspicion)
  fileGeneratedAt    DateTime?  // When the SAT file was generated (via notice)
  submittedAt        DateTime?  // When submitted to SAT
  satAcknowledgmentReceipt String? // File URL or reference to SAT acknowledgment (PDF/XML)
  satFolioNumber     String?   // Folio number from SAT acknowledgment
  isOverdue          Boolean    @default(false) // Computed: true if submissionDeadline has passed and status != SUBMITTED
  
  // Review and cancellation
  notes             String?
  reviewedAt        DateTime?
  reviewedBy        String?
  cancelledAt       DateTime?
  cancelledBy       String?
  cancellationReason String?  // Reason for cancellation
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  alertRule AlertRule @relation(fields: [alertRuleId], references: [id], onDelete: Restrict)
  client    Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  report    Report?   @relation(fields: [reportId], references: [id], onDelete: SetNull)
  notice    Notice?   @relation(fields: [noticeId], references: [id], onDelete: SetNull)

  @@map("alerts")
  @@index([organizationId])
  @@index([alertRuleId])
  @@index([clientId])
  @@index([reportId])
  @@index([noticeId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
  @@index([idempotencyKey])
  @@index([submissionDeadline])
  @@index([isOverdue])
  @@index([submittedAt])
  @@index([transactionId])
  @@index([isManual])
}

model UmaValue {
  id          String   @id
  year        Int      @unique // Year this UMA value applies to (e.g., 2025)
  dailyValue  Decimal  // UMA daily value for the year
  effectiveDate DateTime // Date when this UMA value becomes effective
  endDate     DateTime? // Optional: date when this UMA value expires (usually end of year)
  approvedBy  String?  // User who approved/configured this value (Compliance Officer)
  notes       String?  // Optional notes about the UMA value
  active      Boolean  @default(true) // Whether this is the current active UMA value
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("uma_values")
  @@index([year])
  @@index([active])
  @@index([effectiveDate])
}

// Organization Settings - stores RFC and vulnerable activity for the organization
// Linked 1:1 to organization (from auth-svc better-auth organization plugin)
model OrganizationSettings {
  id                    String   @id
  organizationId        String   @unique // Organization ID from auth-svc
  obligatedSubjectKey   String   // RFC (clave_sujeto_obligado) - 12 characters
  activityKey           String   // Vulnerable activity code (e.g., "VEH") - reference to vulnerable-activities catalog
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("organization_settings")
  @@index([organizationId])
  @@index([obligatedSubjectKey])
  @@index([activityKey])
}

// Notice - SAT regulatory submissions (avisos) with 17-17 period handling
model Notice {
  id              String       @id
  organizationId  String       // Organization this notice belongs to
  name            String       // Display name (e.g., "Aviso Diciembre 2024")
  status          NoticeStatus @default(DRAFT)
  periodStart     DateTime     // Day 17 of previous month
  periodEnd       DateTime     // Day 16 of current month
  reportedMonth   String       // YYYYMM format for SAT
  recordCount     Int          @default(0) // Number of alerts included
  
  // XML file output
  xmlFileUrl      String?      // R2 URL of SAT XML
  fileSize        Int?         // XML file size in bytes
  
  generatedAt     DateTime?    // When the XML was generated
  submittedAt     DateTime?    // When submitted to SAT
  satFolioNumber  String?      // SAT acknowledgment folio number
  createdBy       String?      // User ID who created the notice
  notes           String?      // Optional notes
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  alerts          Alert[]      // Alerts included in this notice

  @@map("notices")
  @@index([organizationId])
  @@index([status])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([reportedMonth])
}

// Report - Analytics and business intelligence reports (PDF)
model Report {
  id              String           @id
  organizationId  String           // Organization this report belongs to
  name            String           // Display name (e.g., "Monthly Report December 2024")
  
  // Report configuration
  template        ReportTemplate   @default(CUSTOM)
  periodType      ReportPeriodType @default(CUSTOM)
  periodStart     DateTime         // Start of reporting period
  periodEnd       DateTime         // End of reporting period
  
  // Optional comparison period for trend analysis
  comparisonPeriodStart DateTime?
  comparisonPeriodEnd   DateTime?
  
  // Data sources and filtering (stored as JSON)
  dataSources     String           @default("[\"ALERTS\"]") // JSON array: ["ALERTS", "TRANSACTIONS", "CLIENTS"]
  filters         String           @default("{}") // JSON object with filter configuration
  clientId        String?          // For CLIENT_RISK_PROFILE template
  
  // Visualization settings (stored as JSON)
  charts          String           @default("[]") // JSON array of chart configurations
  includeSummaryCards  Boolean     @default(true)
  includeDetailTables  Boolean     @default(true)
  
  // Report state
  status          ReportStatus     @default(DRAFT)
  
  // PDF output
  pdfFileUrl      String?          // R2 URL of PDF report
  fileSize        Int?             // PDF file size in bytes
  
  generatedAt     DateTime?        // When the PDF was generated
  createdBy       String?          // User ID who created the report
  notes           String?          // Optional notes
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  alerts          Alert[]          // Alerts included in this report (for filtering/aggregation)
  client          Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@map("reports")
  @@index([organizationId])
  @@index([template])
  @@index([periodType])
  @@index([status])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([clientId])
}
